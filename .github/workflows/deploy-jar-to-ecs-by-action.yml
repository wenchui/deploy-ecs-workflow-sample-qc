name: "commit-master"

on:
  push:
    branches: 
    - 'master'

env:
  ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'
  CURRENT_DATE: ''
  ipaddr: ${ip_address}
  REGIONID: ${region_id} 
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Check Out 
      uses: actions/checkout@v2

    - name: check env set and output
      run: |
        echo "##[set-env name=CURRENT_DATE;]$(date +%Y-%m-%d-%H-%M-%S)"
        echo ${{ env.CURRENT_DATE }}

    # 停止服务并备份老版本,初次部署可以跳过
    - name: backup app and service file
      uses: huaweicloud/ssh-remote-action@v1.0.0
      with:
        ipaddr: ${{ env.ipaddr }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        commands: |
          systemctl status demoapp.service
          systemctl stop demoapp.service
          mkdir -p /opt/backup/demoapp/${{ env.CURRENT_DATE }}
          mv /usr/local/demoapp.jar /opt/backup/demoapp/${{ env.CURRENT_DATE }}
          cp /usr/local/start-demoapp.sh /opt/backup/demoapp/${{ env.CURRENT_DATE }}
          cp /usr/local/stop-demoapp.sh /opt/backup/demoapp/${{ env.CURRENT_DATE }}
          cp /etc/systemd/system/demoapp.service /opt/backup/demoapp/${{ env.CURRENT_DATE }}
          ls -la /opt/backup/demoapp/${{ env.CURRENT_DATE }}
